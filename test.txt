from pymongo import MongoClient, ReturnDocument
from pymongo.errors import PyMongoError
from datetime import datetime





def reserve_next_n(
    sequence_name: str,
    n: int
) -> tuple[int, int]:
    """
    Atomically reserves next N sequence numbers.
    Fails if counter document does not exist.
    """

    if n <= 0:
        raise ValueError("n must be > 0")

    try:
        doc = counters.find_one_and_update(
            {"_id": sequence_name},
            {"$inc": {"seq": n}},
            upsert=False,  # ğŸ‘ˆ critical
            return_document=ReturnDocument.AFTER
        )

        if doc is None:
            raise RuntimeError(
                f"Sequence '{sequence_name}' does not exist"
            )

        end = doc["seq"]
        start = end - n + 1

        return start, end

    except PyMongoError as e:
        raise RuntimeError("Failed to reserve sequence block") from e




def generate_next_n_trade_ids(n: int) -> list[str]:
    start, end = reserve_next_n("trade_id", n)

    year = datetime.utcnow().year

    return [
        f"TRD-{year}-{seq:08d}"
        for seq in range(start, end + 1)
    ]
